# BM25 Retriever

本指南展示如何使用 `BM25Retriever` 基于 Okapi BM25 评分进行关键词文档检索。

## 概述

BM25（Best Matching 25）是一种经典的信息检索算法，基于词频、逆文档频率和文档长度归一化对文档进行评分。与基于向量的检索不同，BM25 不需要 Embeddings -- 它直接作用于文本。

BM25 适用于以下场景：
- 你需要精确的关键词匹配而非语义相似性。
- 你希望在不计算 Embeddings 的情况下实现快速检索。
- 你想将其与向量 Retriever 组合使用（参见 [Ensemble Retriever](ensemble.md)）。

## 基本用法

```rust
use synaptic::retrieval::{BM25Retriever, Document, Retriever};

let docs = vec![
    Document::new("1", "Rust is a systems programming language focused on safety"),
    Document::new("2", "Python is widely used for data science and machine learning"),
    Document::new("3", "Go was designed at Google for concurrent programming"),
    Document::new("4", "Rust provides memory safety without garbage collection"),
];

let retriever = BM25Retriever::new(docs);

let results = retriever.retrieve("Rust memory safety", 2).await?;
// Returns documents 4 and 1 (highest BM25 scores for those query terms)
```

Retriever 在构建时预计算词频、文档长度和逆文档频率，因此检索本身非常快。

## 自定义 BM25 参数

BM25 有两个调优参数：

- **k1**（默认 `1.5`）-- 控制词频饱和度。较高的值赋予词频更多权重。
- **b**（默认 `0.75`）-- 控制文档长度归一化。`1.0` 表示完全长度归一化；`0.0` 表示不进行长度归一化。

```rust
let retriever = BM25Retriever::with_params(docs, 1.2, 0.8);
```

## 评分原理

对于每个查询词，BM25 计算：

```
score = IDF * (tf * (k1 + 1)) / (tf + k1 * (1 - b + b * dl / avgdl))
```

其中：
- **IDF** = `ln((N - df + 0.5) / (df + 0.5) + 1)` -- 逆文档频率
- **tf** -- 该词在文档中的词频
- **dl** -- 文档长度（以 Token 计）
- **avgdl** -- 语料库中的平均文档长度
- **N** -- 文档总数
- **df** -- 包含该词的文档数

总分为零的文档（没有匹配的词）会被排除在结果之外。

## 与向量搜索组合

BM25 通过 `EnsembleRetriever` 与向量检索配合良好。这让你同时获得关键词匹配和语义搜索的优势：

```rust
use std::sync::Arc;
use synaptic::retrieval::{BM25Retriever, EnsembleRetriever, Retriever};

let bm25 = Arc::new(BM25Retriever::new(docs.clone()));
let vector_retriever = Arc::new(/* VectorStoreRetriever */);

let ensemble = EnsembleRetriever::new(vec![
    (vector_retriever as Arc<dyn Retriever>, 0.5),
    (bm25 as Arc<dyn Retriever>, 0.5),
]);

let results = ensemble.retrieve("query", 5).await?;
```

更多关于组合 Retriever 的详情，请参见 [Ensemble Retriever](ensemble.md)。
